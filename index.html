<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tracker Setup</title>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background: #f4f6f9;
}

h1 { text-align: center; }

.setup-container {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
}

.setup-btn {
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    background: #e0e0e0;
    cursor: pointer;
}

.setup-btn.active {
    background: #007bff;
    color: white;
}

.checklist { margin-top: 20px; }

.item { margin: 10px 0; }

.score-box {
    margin-top: 20px;
    font-size: 20px;
    font-weight: bold;
    text-align: center;
}

.result-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.result-buttons button {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: bold;
}

.win-btn { background: #28a745; color: white; }
.lose-btn { background: #dc3545; color: white; }

.history {
    margin-top: 30px;
}

.history-entry {
    background: white;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.win { color: #28a745; font-weight: bold; }
.lose { color: #dc3545; font-weight: bold; }

.stats-box {
    background: white;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
}

select {
    width: 100%;
    padding: 8px;
    margin-bottom: 15px;
    border-radius: 8px;
}

.bottom-buttons button {
    margin-top: 10px;
    padding: 10px;
    width: 100%;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 15px;
}

.export-btn { background: #ffc107; }
.clear-btn { background: #6c757d; color: white; }

</style>
</head>

<body>

<h1>Tracker Setup</h1>

<div class="setup-container">
    <button class="setup-btn active" onclick="showSetup('setup1', this)">Setup 1</button>
    <button class="setup-btn" onclick="showSetup('setup2', this)">Setup 2</button>
    <button class="setup-btn" onclick="showSetup('setup3', this)">Setup 3</button>
</div>

<div id="checklist" class="checklist"></div>

<div class="score-box">
    Score : <span id="score">0</span> / 100
</div>

<div class="result-buttons">
    <button class="win-btn" onclick="setResult('WIN')">WIN</button>
    <button class="lose-btn" onclick="setResult('LOSE')">LOSE</button>
</div>

<button onclick="saveScore()">Enregistrer</button>

<div class="history">

    <h2>Statistiques</h2>
    <div id="stats" class="stats-box"></div>

    <h2>Filtrer par tâche cochée</h2>
    <select id="taskFilter" onchange="renderHistory()">
        <option value="">-- Aucun filtre --</option>
    </select>

    <h2>Historique</h2>
    <div id="historyList"></div>

    <div class="bottom-buttons">
        <button class="export-btn" onclick="exportCSV()">Exporter CSV</button>
        <button class="clear-btn" onclick="clearHistory()">Supprimer l'historique</button>
    </div>

</div>

<script>

const setups = {
    setup1: [
        { label: "Tâche A", points: 10 },
        { label: "Tâche B", points: 20 },
        { label: "Tâche C", points: 30 }
    ],
    setup2: [
        { label: "Action 1", points: 25 },
        { label: "Action 2", points: 25 },
        { label: "Action 3", points: 50 }
    ],
    setup3: [
        { label: "Étape X", points: 40 },
        { label: "Étape Y", points: 60 }
    ]
};

let currentSetup = "setup1";
let currentResult = null;

function showSetup(name, btn) {
    currentSetup = name;
    document.querySelectorAll('.setup-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderChecklist();
}

function renderChecklist() {
    const div = document.getElementById("checklist");
    div.innerHTML = "";
    setups[currentSetup].forEach((item, i) => {
        div.innerHTML += `
            <div class="item">
                <label>
                    <input type="checkbox" id="item${i}" onchange="calculateScore()">
                    ${item.label} (${item.points} pts)
                </label>
            </div>
        `;
    });
    calculateScore();
}

function calculateScore() {
    let total = 0;
    let gained = 0;
    setups[currentSetup].forEach((item, i) => {
        total += item.points;
        if (document.getElementById("item"+i).checked) gained += item.points;
    });
    let score = total ? Math.round((gained/total)*100) : 0;
    document.getElementById("score").textContent = score;
    return score;
}

function setResult(result) {
    currentResult = result; // plus d'alert
}

function saveScore() {
    if (!currentResult) {
        alert("Choisis WIN ou LOSE avant d'enregistrer");
        return;
    }

    const checkedTasks = [];
    setups[currentSetup].forEach((item, i) => {
        if (document.getElementById("item"+i).checked) {
            checkedTasks.push(item.label);
        }
    });

    const history = JSON.parse(localStorage.getItem("scoreHistory")) || [];

    history.push({
        setup: currentSetup,
        score: calculateScore(),
        result: currentResult,
        tasks: checkedTasks,
        date: new Date().toLocaleString()
    });

    localStorage.setItem("scoreHistory", JSON.stringify(history));
    renderHistory();
    renderStats();
}

function renderStats() {
    const history = JSON.parse(localStorage.getItem("scoreHistory")) || [];
    const statsDiv = document.getElementById("stats");
    let stats = "";

    ["setup1","setup2","setup3"].forEach(setup => {
        const entries = history.filter(e => e.setup === setup);
        if (!entries.length) return;

        const wins = entries.filter(e => e.result === "WIN").length;
        const winRate = Math.round((wins / entries.length) * 100);
        stats += `${setup} : ${winRate}% win rate (${wins}/${entries.length})<br>`;
    });

    statsDiv.innerHTML = stats || "Aucune donnée";
}

function renderHistory() {
    const list = document.getElementById("historyList");
    const filter = document.getElementById("taskFilter").value;
    const history = JSON.parse(localStorage.getItem("scoreHistory")) || [];
    list.innerHTML = "";

    history.slice().reverse().forEach(entry => {
        if (filter && !entry.tasks.includes(filter)) return;

        list.innerHTML += `
            <div class="history-entry">
                <strong>${entry.setup}</strong><br>
                Score : ${entry.score}/100<br>
                Résultat : <span class="${entry.result === 'WIN' ? 'win' : 'lose'}">${entry.result}</span><br>
                Tâches cochées : ${entry.tasks.join(", ")}<br>
                <small>${entry.date}</small>
            </div>
        `;
    });
}

function clearHistory() {
    if (confirm("Supprimer tout l'historique ?")) {
        localStorage.removeItem("scoreHistory");
        renderHistory();
        renderStats();
    }
}

function exportCSV() {
    const history = JSON.parse(localStorage.getItem("scoreHistory")) || [];
    if (!history.length) return alert("Aucune donnée");

    let csv = "Setup,Score,Result,Tasks,Date\n";
    history.forEach(e => {
        csv += `${e.setup},${e.score},${e.result},"${e.tasks.join(" | ")}",${e.date}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "historique_setups.csv";
    a.click();
}

function populateFilter() {
    const select = document.getElementById("taskFilter");
    const allTasks = new Set();

    Object.values(setups).forEach(setup => {
        setup.forEach(task => allTasks.add(task.label));
    });

    allTasks.forEach(task => {
        select.innerHTML += `<option value="${task}">${task}</option>`;
    });
}

populateFilter();
renderChecklist();
renderHistory();
renderStats();

</script>

</body>
</html>
