<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trading Setup Tracker</title>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background: #f4f6f9;
}

h1 { text-align: center; }

.setup-container {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
}

.setup-btn {
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    background: #e0e0e0;
    cursor: pointer;
    font-weight: bold;
}

.setup-btn.active {
    background: #007bff;
    color: white;
}

.checklist { margin-top: 20px; }

.item { margin: 8px 0; }

.score-box {
    margin-top: 20px;
    font-size: 20px;
    font-weight: bold;
    text-align: center;
}

.result-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.result-buttons button {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: bold;
}

.win-btn { background: #28a745; color: white; }
.lose-btn { background: #dc3545; color: white; }

button {
    margin-top: 10px;
    padding: 10px;
    width: 100%;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
}

.history { margin-top: 30px; }

.history-entry {
    background: white;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.win { color: #28a745; font-weight: bold; }
.lose { color: #dc3545; font-weight: bold; }

.stats-box {
    background: white;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
}

.filter-box label {
    display: block;
    margin-bottom: 5px;
}

.export-btn { background: #ffc107; }
.clear-btn { background: #6c757d; color: white; }

</style>
</head>

<body>

<h1>Trading Setup Tracker</h1>

<div class="setup-container">
    <button class="setup-btn active" onclick="showSetup('LO Reversal', this)">LO Reversal</button>
    <button class="setup-btn" onclick="showSetup('NY Continuation', this)">NY Continuation</button>
    <button class="setup-btn" onclick="showSetup('NY Reversal', this)">NY Reversal</button>
</div>

<div id="checklist" class="checklist"></div>

<div class="score-box">
    Score : <span id="score">0</span> / 100
</div>

<div class="result-buttons">
    <button class="win-btn" onclick="setResult('WIN')">WIN</button>
    <button class="lose-btn" onclick="setResult('LOSE')">LOSE</button>
</div>

<button onclick="saveScore()">Enregistrer</button>

<div class="history">

    <h2>Statistiques</h2>
    <div id="stats" class="stats-box"></div>

    <h2>Filtrer par tâches cochées</h2>
    <div id="taskFilters" class="filter-box"></div>

    <h2>Historique</h2>
    <div id="historyList"></div>

    <button class="export-btn" onclick="exportCSV()">Exporter CSV</button>
    <button class="clear-btn" onclick="clearHistory()">Supprimer l'historique</button>

</div>

<script>

const setups = {

"LO Reversal": [
"Trading conditions",
"Biais & Liquidity",
"Narrative",
"Respect bias HTF (at least h1)",
"Asia range near to HTF POI",
"LO trades above/below Asia high/low into HTF POI",
"SL Strong low/high m15",
"m15 / double m5 CIOF after manipulation high/low"
],

"NY Continuation": [
"Trading conditions",
"Biais & Liquidity",
"Narrative",
"Respect bias HTF (at least h1)",
"LO made the H/LOTD after manipulating Asia highs/lows into an HTF key level",
"LO do not touch major DOL",
"Wait stop run lunch highs/low and CIOF m5/m15",
"Avoid if LO session >70 pips (NY will probably consolidate)"
],

"NY Reversal": [
"Trading conditions",
"Biais & Liquidity",
"Narrative",
"Respect bias HTF (at least h1)",
"Asia & LO highs/lows intacts",
"Clean DOL",
"CIOF m5/m15 or smt"
]

};

let currentSetup = "LO Reversal";
let currentResult = null;

function showSetup(name, btn) {
    currentSetup = name;
    document.querySelectorAll('.setup-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderChecklist();
}

function renderChecklist() {
    const div = document.getElementById("checklist");
    div.innerHTML = "";

    const pointsPerTask = 100 / setups[currentSetup].length;

    setups[currentSetup].forEach((task, i) => {
        div.innerHTML += `
            <div class="item">
                <label>
                    <input type="checkbox" id="item${i}" onchange="calculateScore()">
                    ${task} (${pointsPerTask.toFixed(1)} pts)
                </label>
            </div>
        `;
    });

    calculateScore();
}

function calculateScore() {
    const pointsPerTask = 100 / setups[currentSetup].length;
    let gained = 0;

    setups[currentSetup].forEach((task, i) => {
        if (document.getElementById("item"+i).checked) {
            gained += pointsPerTask;
        }
    });

    const score = Math.round(gained);
    document.getElementById("score").textContent = score;
    return score;
}

function setResult(result) {
    currentResult = result;
}

function saveScore() {
    if (!currentResult) {
        alert("Choisis WIN ou LOSE avant d'enregistrer");
        return;
    }

    const checkedTasks = [];
    setups[currentSetup].forEach((task, i) => {
        if (document.getElementById("item"+i).checked) {
            checkedTasks.push(task);
        }
    });

    const history = JSON.parse(localStorage.getItem("scoreHistory")) || [];

    history.push({
        setup: currentSetup,
        score: calculateScore(),
        result: currentResult,
        tasks: checkedTasks,
        date: new Date().toLocaleString()
    });

    localStorage.setItem("scoreHistory", JSON.stringify(history));

    renderHistory();
    renderStats();
}

function renderStats() {
    const history = JSON.parse(localStorage.getItem("scoreHistory")) || [];
    const statsDiv = document.getElementById("stats");
    statsDiv.innerHTML = "";

    Object.keys(setups).forEach(setup => {
        const entries = history.filter(e => e.setup === setup);
        if (!entries.length) return;

        const wins = entries.filter(e => e.result === "WIN").length;
        const winRate = Math.round((wins / entries.length) * 100);

        statsDiv.innerHTML += `${setup} : ${winRate}% win rate (${wins}/${entries.length})<br>`;
    });

    if (!statsDiv.innerHTML) statsDiv.innerHTML = "Aucune donnée";
}

function renderHistory() {
    const list = document.getElementById("historyList");
    const history = JSON.parse(localStorage.getItem("scoreHistory")) || [];
    list.innerHTML = "";

    const selectedFilters = Array.from(
        document.querySelectorAll("#taskFilters input:checked")
    ).map(cb => cb.value);

    history.slice().reverse().forEach(entry => {

        if (selectedFilters.length > 0) {
            const hasAll = selectedFilters.every(task =>
                entry.tasks.includes(task)
            );
            if (!hasAll) return;
        }

        list.innerHTML += `
            <div class="history-entry">
                <strong>${entry.setup}</strong><br>
                Score : ${entry.score}/100<br>
                Résultat : <span class="${entry.result === 'WIN' ? 'win' : 'lose'}">${entry.result}</span><br>
                Tâches cochées : ${entry.tasks.join(", ")}<br>
                <small>${entry.date}</small>
            </div>
        `;
    });
}

function clearHistory() {
    if (confirm("Supprimer tout l'historique ?")) {
        localStorage.removeItem("scoreHistory");
        renderHistory();
        renderStats();
    }
}

function exportCSV() {
    const history = JSON.parse(localStorage.getItem("scoreHistory")) || [];
    if (!history.length) return alert("Aucune donnée");

    let csv = "Setup,Score,Result,Tasks,Date\n";

    history.forEach(e => {
        csv += `${e.setup},${e.score},${e.result},"${e.tasks.join(" | ")}",${e.date}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "trading_setups_history.csv";
    a.click();
}

function populateFilter() {
    const container = document.getElementById("taskFilters");
    const allTasks = new Set();

    Object.values(setups).forEach(setup => {
        setup.forEach(task => allTasks.add(task));
    });

    allTasks.forEach(task => {
        container.innerHTML += `
            <label>
                <input type="checkbox" value="${task}" onchange="renderHistory()">
                ${task}
            </label>
        `;
    });
}

populateFilter();
renderChecklist();
renderHistory();
renderStats();

</script>

</body>
</html>
